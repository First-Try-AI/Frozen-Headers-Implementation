# FTA Synth Service

A modularized Cloud Run service for audio synthesis using ElevenLabs TTS and Google Cloud Storage.

## Architecture

The service is split into three focused modules:

### textProcessor.js
- Text processing and normalization
- Voice selection logic
- Chunk structuring for audio generation
- Configuration for voices and synthesis parameters

### audioProcessor.js
- ElevenLabs API integration
- FFmpeg audio processing
- Volume normalization
- Audio trimming and optimization

### outputProcessor.js (Orchestrator)
- Coordinates timestamp generation, pagination, and storage
- Imports from specialized modules:
  - timestamp-module.js: Word timestamp generation
  - pagination-module.js: Audio-driven page break creation with gap elimination
  - gcs-module.js: Google Cloud Storage uploads and signed URLs

## API Endpoints

### POST /process-input (NEW - Primary Endpoint)
Processes raw input text with automatic chunking and routing. This is the main endpoint that frontends should use.

**Request Body:**
```json
{
  "userText": "raw text to process",
  "originalParams": {
    "voiceGender": "shuffled",
    "speakerMode": "readingRainbow",
    "speed": 0.8
  },
  "sessionId": "unique-session-id",
  "customVoices": ["voice-id-1", "voice-id-2"],
  "thresholds": {
    "breakPauseFirst": 100,
    "breakPauseSecond": 70,
    "usePrimary": true,
    "useSecondary": false
  }
}
```

**Response Body Structure:**

The service returns a JSON object with the following top-level keys:
- `success`: A boolean indicating if the request was successful.
- `sessionId`: The unique session ID for the transaction.
- `totalChunks`: The total number of audio chunks created.
- `chunks`: An array of chunk objects, each containing detailed information.
- `summary`: An object with aggregate data like total words and duration.

**Chunk Object Details:**

Each object inside the `chunks` array contains the following keys:
- `chunkIndex`: The zero-based index of the chunk.
- `inputText`: The original, unmodified text for this chunk.
- `originalText`: The full original text from which this chunk was derived (for line break preservation).
- `fullChunkDisplay`: Structured display data for the FullChunkDisplay frontend state (see below).
- `audioUrl`: A signed URL to the generated MP3 audio file.
- `timestampsUrl`: A signed URL to the JSON file containing word-level timestamps.
- `letterTimestampsUrl`: A signed URL to the JSON file containing letter-level timestamps.
- `pages`: An array of page objects containing page break information.
- `wordCount`: The total number of words in the chunk.
- `totalDuration`: The total duration of the audio for the chunk in seconds.
- `voiceUsed`: The voice ID used for this chunk's audio generation.
- `fallbackUsed`: Boolean indicating if a fallback voice was used.
- `pagination`: An object containing a summary of the pagination for this chunk (`totalBreaks`, `totalWords`, `totalPages`, etc.).

### FullChunkDisplay Feature

The `fullChunkDisplay` field provides spoon-fed display data that enables the FullChunkDisplay frontend state with click-to-seek functionality and word highlighting.

**Structure:**
```json
{
  "originalText": "The original text with\n\nparagraph breaks\nand line breaks",
  "displayElements": [
    {
      "type": "word",
      "word": "Hello",
      "startTime": 0.5,
      "endTime": 1.2,
      "wordIndex": 1
    },
    {
      "type": "word",
      "word": "world",
      "startTime": 1.3,
      "endTime": 2.1,
      "wordIndex": 2
    },
    {
      "type": "line-break",
      "content": "\n"
    },
    {
      "type": "paragraph-break",
      "content": "\n\n"
    }
  ],
  "totalWords": 150,
  "chunkIndex": 0
}
```

**Element Types:**
- **`word`**: Individual words with timing data for click-to-seek and highlighting
- **`line-break`**: Single line breaks (`\n`) that preserve text formatting
- **`paragraph-break`**: Double line breaks (`\n\n`) that create visual paragraph separation

**Features:**
- **Preserved Formatting**: Maintains original line breaks and paragraph breaks from input text
- **Timing Integration**: Each word is connected to its precise start/end times for click-to-seek
- **Sequential Indexing**: Words have sequential `wordIndex` values for highlighting coordination
- **Chunk-Specific**: Each chunk gets its own portion of text, not the full original text
- **Frontend Ready**: All data needed for display, interaction, and highlighting is included

**Response:**
- Single chunk: Returns audio/timestamps/pageBreaks URLs with pagination summary
- Multiple chunks: Returns chunks array with individual URLs and summary

**Features:**
- Automatic 500-character chunking with smart split points
- Voice selection and text processing for all chunks
- Intelligent routing based on actual chunk count
- Audio-driven pagination using natural pause points with configurable thresholds
- Flexible threshold control with independent enable/disable states

### POST /process-all (Legacy - Not Available)
This endpoint has been removed. Use `/process-input` instead.

### POST /process-single (Legacy - Not Available)  
This endpoint has been removed. Use `/process-input` instead.

### GET /health
Health check endpoint.

## Environment Variables

- `ELEVENLABS_TTS_ENT` - ElevenLabs API key (secret)
- `GOOGLE_CLOUD_PROJECT_ID` - Google Cloud project ID
- `GCS_BUCKET_NAME` - Google Cloud Storage bucket name
- `PORT` - Server port (default: 8080)

## Features

- **Automatic Chunking**: Smart 500-character chunking with intelligent split points
- **Voice Selection**: Advanced voice selection with vlist support and voice modes
- **Text Processing**: Calm script and tail text integration for all chunks
- **Intelligent Routing**: Automatic routing based on actual chunk count
- **Volume Normalization**: All audio is processed with loudnorm filter
- **Word Timestamps**: Precise timing data for each word
- **Voice Variety**: 100+ voices across lower and higher pitch ranges
- **Parallel Processing**: Multiple chunks processed simultaneously
- **Audio-Driven Pagination**: Natural pause point detection with configurable thresholds
- **Gap Elimination**: Automatic elimination of gaps between page boundaries with 1ms overlap prevention
- **Precision Matching**: Page boundaries rounded to 3 decimal places to match word timestamp precision
- **Threshold Control**: Independent enable/disable states for primary and secondary thresholds
- **FullChunkDisplay**: Spoon-fed display data preserving line breaks and paragraph breaks with click-to-seek timing
- **Chunk-Specific Display**: Each chunk gets its own formatted display elements, not the full text
- **Frontend Integration**: Ready-to-use display data for word highlighting and click-to-seek functionality
- **Error Handling**: Graceful fallbacks and detailed error reporting

## Pagination System

The pagination system uses audio-driven page breaks based on natural pause points in speech, with automatic gap elimination and precision matching:

### Gap Elimination
- Automatically detects gaps between consecutive page boundaries
- Calculates gap midpoint and adjusts boundaries to eliminate gaps
- Adds 1ms buffer between pages to prevent overlap
- Rounds all boundaries to 3 decimal places for precision matching with word timestamps

### Threshold Configuration

### Threshold Parameters:
- **`breakPauseFirst`**: Primary threshold in milliseconds (default: 100ms)
- **`breakPauseSecond`**: Secondary threshold in milliseconds (default: 70ms)  
- **`usePrimary`**: Enable/disable primary threshold (default: true)
- **`useSecondary`**: Enable/disable secondary threshold (default: false)

### Threshold Logic:
- **Primary Only**: Finds pauses > `breakPauseFirst` milliseconds
- **Secondary Only**: Finds pauses > `breakPauseSecond` milliseconds  
- **Both Enabled**: Finds pauses > `breakPauseFirst` OR between `breakPauseSecond` and `breakPauseFirst`
- **Both Disabled**: No page breaks (single page)

### Example Configurations:
```json
// Both thresholds enabled (most breaks)
{"breakPauseFirst": 100, "breakPauseSecond": 70, "usePrimary": true, "useSecondary": true}

// Primary only (fewer, longer breaks)
{"breakPauseFirst": 121, "breakPauseSecond": 70, "usePrimary": true, "useSecondary": false}

// Secondary only (more, shorter breaks)
{"breakPauseFirst": 100, "breakPauseSecond": 70, "usePrimary": false, "useSecondary": true}

// No breaks (single page)
{"breakPauseFirst": 100, "breakPauseSecond": 70, "usePrimary": false, "useSecondary": false}
```

- **Cleanup**: Automatic temporary file cleanup

## Deployment

Deploy to Google Cloud Run using the provided deployment script:
```bash
./deploy-synth.sh
```

## Testing

Test the service health and main endpoint:
```bash
# Health check
curl https://fta-synth-pyh6ygakfa-uc.a.run.app/health

# Test main endpoint (both thresholds enabled)
curl -X POST https://fta-synth-pyh6ygakfa-uc.a.run.app/process-input \
  -H "Content-Type: application/json" \
  -d '{"userText": "Test text", "sessionId": "test-123", "originalParams": {"voiceGender": "shuffled", "speakerMode": "readingRainbow", "speed": 0.8}, "customVoices": [], "thresholds": {"breakPauseFirst": 100, "breakPauseSecond": 70, "usePrimary": true, "useSecondary": true}}'

# Test with only primary threshold (121ms)
curl -X POST https://fta-synth-pyh6ygakfa-uc.a.run.app/process-input \
  -H "Content-Type: application/json" \
  -d '{"userText": "Test text", "sessionId": "test-123", "originalParams": {"voiceGender": "shuffled", "speakerMode": "readingRainbow", "speed": 0.8}, "customVoices": [], "thresholds": {"breakPauseFirst": 121, "breakPauseSecond": 70, "usePrimary": true, "useSecondary": false}}'

# Test fullChunkDisplay functionality
curl -X POST https://fta-synth-pyh6ygakfa-uc.a.run.app/process-input \
  -H "Content-Type: application/json" \
  -d '{"userText": "Hello world.\n\nThis is a new paragraph with multiple lines.\nEach chunk will have its own display elements.", "sessionId": "test-fcd", "originalParams": {"voiceGender": "shuffled", "speakerMode": "readingRainbow", "speed": 0.8}, "customVoices": [], "thresholds": {"breakPauseFirst": 100, "breakPauseSecond": 70, "usePrimary": true, "useSecondary": false}}' | jq '.chunks[0].fullChunkDisplay'
```